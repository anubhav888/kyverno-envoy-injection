apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: envoy-sidecar-injection
  annotations:
    policies.kyverno.io/title: Disallow hostPorts
    policies.kyverno.io/category: Pod Security Standards (Baseline)
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    kyverno.io/kyverno-version: 1.6.0
    kyverno.io/kubernetes-version: "1.22-1.23"
    policies.kyverno.io/description: >-
      Access to host ports allows potential snooping of network traffic and should not be
      allowed, or at minimum restricted to a known list. This policy ensures the `hostPort`
      field is unset or set to `0`.       
spec:
  validationFailureAction: audit
  background: true
  rules:
    - name: match-pod-label
      match:
        any:
        - resources:
            kinds:
              - Pod
      preconditions:
        any:
        - key: "{{ request.object.metadata.labels.nirmata.io/service.name || '' }}"
          operator: Equals
          value: static-file
           mutate:
        patchStrategicMerge:
          spec:
            containers
            - name: envoy
              image: envoyproxy/envoy-alpine:v1.14.1
              imagePullPolicy: Always
              args: ["-l", "debug", "--local-address-ip-version", "v4", "-c", "/run/envoy/envoy.yaml", "--base-id", "1"]
              volumeMounts:
              - name: envoy-config
              mountPath: "/run/envoy"
              readOnly: true
            - name: spire-agent-socket
              mountPath: /run/spire/sockets
              readOnly: true
